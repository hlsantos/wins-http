(function(c){c.fn.extend({autocomplete:function(a,b){var i="string"==typeof a,b=c.extend({},c.Autocompleter.defaults,{url:i?a:null,data:i?null:a,delay:i?c.Autocompleter.defaults.delay:10,max:b&&!b.scroll?10:100},b);b.highlight=b.highlight||function(a){return a};b.moreItems=b.moreItems||"";return this.each(function(){new c.Autocompleter(this,b)})},result:function(a){return this.bind("result",a)},search:function(a){return this.trigger("search",[a])},flushCache:function(){return this.trigger("flushCache")},
setOptions:function(a){return this.trigger("setOptions",[a])},unautocomplete:function(){return this.trigger("unautocomplete")}});c.Autocompleter=function(a,b){var i,p;function n(){var a=f.selected();if(!a)return!1;var g=a.result;s=g;if(b.multiple){var c=o(d.val());1<c.length&&(g=c.slice(0,c.length-1).join(b.multipleSeparator)+b.multipleSeparator+g);g+=b.multipleSeparator}d.val(g);l();d.trigger("result",[a.data,a.value]);return!0}function m(a,g){if(v==p)f.hide();else{var c=d.val();if(g||c!=s)s=c,c=
r(c),c.length>=b.minChars?(d.addClass(b.loadingClass),b.matchCase||(c=c.toLowerCase()),h(c,k,l)):(e(),f.hide())}}function o(a){if(!a)return[""];var a=a.split(c.trim(b.multipleSeparator)),g=[];c.each(a,function(a,b){c.trim(b)&&(g[a]=c.trim(b))});return g}function r(a){if(!b.multiple)return a;a=o(a);return a[a.length-1]}function l(){f.hide();clearTimeout(t);e();b.mustMatch&&d.search(function(a){a||d.val("")})}function k(g,h){if(h&&h.length&&q){e();f.display(h,g);var w=h[0].value;b.autoFill&&(r(d.val()).toLowerCase()==
g.toLowerCase()&&8!=v)&&(d.val(d.val()+w.substring(r(s).length)),c.Autocompleter.Selection(a,s.length,s.length+w.length));f.show()}else l()}function u(a,g){b.matchCase||(a=a.toLowerCase());var c=a.indexOf(g);return-1==c?!1:0==c||b.matchContains}function h(g,h,f){b.matchCase||(g=g.toLowerCase());var d=j.load(g);if(d&&d.length)return h(g,d),i=r(g),!0;if("string"==typeof b.url&&0<b.url.length){if(b.listIsSorted&&(i&&""!=i)&&u(r(g),i))return e(),!0;var l={};c.each(b.extraParams,function(a,g){l[a]="function"==
typeof g?g():g});f=b.url;d=c.extend({q:r(g),limit:b.max},l);b.formatUrl&&(f=b.formatUrl(f,d),f!=b.url&&(d={}));b.formatUrlData&&(d=b.formatUrlData(d));i=r(g);f={url:f,data:d,error:function(){e()},success:function(a){var f;if(!(f=b.parse&&b.parse(a))){f=[];for(var a=a.split("\n"),e=0;e<a.length;e++){var d=c.trim(a[e]);if(d){d=d.split("|");f[f.length]={data:d,value:d[0],result:b.formatResult&&b.formatResult(d,d[0])||d[0]}}}}j.add(g,f);h(g,f)},mode:"abort",port:"autocomplete"+a.name};b.dataType&&(f.dataType=
b.dataType);c.ajax(f);return!0}f(g);return!1}function e(){d.removeClass(b.loadingClass)}p=46;var d=c(a).attr("autocomplete","off").addClass(b.inputClass),t,s="",j=c.Autocompleter.Cache(b),q=0,v;i="";var g={mouseDownOnSelect:!1},f=c.Autocompleter.Select(b,a,n,g);d.keydown(function(a){v=a.keyCode;switch(a.keyCode){case 38:a.preventDefault();f.visible()?f.prev():m(0,!0);break;case 40:a.preventDefault();f.visible()?f.next():m(0,!0);break;case 33:a.preventDefault();f.visible()?f.pageUp():m(0,!0);break;
case 34:a.preventDefault();f.visible()?f.pageDown():m(0,!0);break;case b.multiple&&","==c.trim(b.multipleSeparator)&&188:case 9:case 13:n()&&(b.multiple||d.blur(),a.preventDefault());break;case 27:f.visible()?f.hide():this.value="";break;default:clearTimeout(t),t=setTimeout(m,b.delay)}}).keypress(function(){}).focus(function(){q++}).blur(function(){q=0;g.mouseDownOnSelect||(clearTimeout(t),t=setTimeout(l,200))}).click(function(){1<q++&&!f.visible()&&m(0,!0)}).bind("search",function(){function a(b,
c){var f;if(c&&c.length)for(var e=0;e<c.length;e++)if(c[e].result.toLowerCase()==b.toLowerCase()){f=c[e];break}"function"==typeof g?g(f):d.trigger("result",f&&[f.data,f.value])}var g=1<arguments.length?arguments[1]:null;c.each(o(d.val()),function(g,b){h(b,a,a)})}).bind("flushCache",function(){j.flush()}).bind("setOptions",function(a,g){c.extend(b,g);"data"in g&&j.populate()}).bind("unautocomplete",function(){f.unbind();d.unbind()})};c.Autocompleter.defaults={inputClass:"ac_input",resultsClass:"ac_results",
loadingClass:"ac_loading",overClass:"ac_over",listIsSorted:!0,minChars:1,delay:400,matchCase:!1,matchSubset:!0,matchContains:!1,cacheLength:10,max:100,mustMatch:!1,extraParams:{},selectFirst:!0,formatItem:function(a){return a[0]},moreItems:"",autoFill:!1,width:0,multiple:!1,multipleSeparator:", ",highlight:function(a,b){return a.replace(RegExp("(?![^&;]+;)(?!<[^<>]*)("+b+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:!0,scrollHeight:180,scrollLimit:0,attachTo:"body"};c.Autocompleter.Cache=
function(a){function b(b,c){a.matchCase||(b=b.toLowerCase());var k=b.indexOf(c);return-1==k?!1:0==k||a.matchContains}function i(b,c){o>a.cacheLength&&n();m[b]||o++;m[b]=c}function p(){if(!a.data)return!1;var b={},l=0;a.url||(a.cacheLength=1);b[""]=[];for(var k=0,m=a.data.length;k<m;k++){var h=a.data[k],e=a.formatItem(h,k+1,a.data.length);if(!1!==e){var d=e.charAt(0).toLowerCase();b[d]||(b[d]=[]);h={value:e,data:h,result:a.formatResult&&a.formatResult(h)||e};b[d].push(h);l++<a.max&&b[""].push(h)}}c.each(b,
function(b,c){a.cacheLength++;i(b,c)})}function n(){m={};o=0}var m={},o=0;setTimeout(p,25);return{flush:n,add:i,populate:p,load:function(i){if(!a.cacheLength||!o)return null;if(!a.url&&a.matchContains){var l=[],k;for(k in m)if(0<k.length){var n=m[k];c.each(n,function(a,c){b(c.value,i)&&l.push(c)})}return l}if(m[i])return m[i];if(a.matchSubset)for(k=i.length-1;k>=a.minChars;k--)if(n=m[i.substr(0,k)])return l=[],c.each(n,function(a,c){b(c.value,i)&&(l[l.length]=c)}),l;return null}}};c.Autocompleter.Select=
function(a,b,i,p){var n;function m(){s&&(j=c("<div>").hide().addClass(a.resultsClass).css("position","absolute").appendTo(a.attachTo),q=c("<ul>").appendTo(j).mouseover(function(a){o(a).nodeName&&"LI"==o(a).nodeName.toUpperCase()&&(e=c("li",q).removeClass().index(o(a)),c(o(a)).addClass(n))}).click(function(a){c(o(a)).addClass(n);i();b.focus();return!1}).mousedown(function(){p.mouseDownOnSelect=!0}).mouseup(function(){p.mouseDownOnSelect=!1}),0<a.moreItems.length&&(v=c("<div>").addClass("ac_moreItems").css("display",
"none").html(a.moreItems).appendTo(j)),0<a.width&&j.css("width",a.width),s=!1)}function o(a){for(a=a.target;a&&"LI"!=a.tagName;)a=a.parentNode;return!a?[]:a}function r(a){j[0].scrollTop+=a;return j[0].scrollTop}function l(a,b){return b?h.slice(a,a+1).addClass(n):h.slice(a,a+1).removeClass(n)}function k(a,b){var d=c(h[a]).offset().top;return c(h[b]).offset().top-d}function u(a){var b=e;l(e,!1);0<a?(e+=a,e>=h.size()?e=h.size()-1:(a=(e+1)*h[e].offsetHeight,a>=j[0].offsetHeight&&(b=k(b,e),r(b)))):(e+=
a,0>e?e=0:(a=e*h[e].offsetHeight,a<j[0].scrollTop&&(b=k(e,b),r(-1*b))));l(e,!0)}n=a.overClass;var h,e=-1,d,t="",s=!0,j,q,v;return{display:function(b,f){m();d=b;t=f;q.empty();for(var i=a.max&&a.max<d.length?a.max:d.length,j=0;j<i;j++)if(d[j]){var k=a.formatItem(d[j].data,j+1,i,d[j].value,t);!1!==k&&(k=c("<li>").html(a.highlight(k,t)).appendTo(q)[0],c.data(k,"ac_data",d[j]))}h=q.find("li");a.selectFirst&&(h.slice(0,1).addClass(n),e=0);0<a.moreItems.length&&!a.scroll&&v.css("display",d.length>i?"block":
"none");try{q.bgiframe()}catch(l){}},next:function(){u(1)},prev:function(){u(-1)},pageUp:function(){0!=e&&0>e-8?u(-e):u(-8)},pageDown:function(){e!=h.size()-1&&e+8>h.size()?u(h.size()-1-e):u(8)},hide:function(){j&&j.hide();e=-1},visible:function(){return j&&j.is(":visible")},current:function(){return this.visible()&&(h.filter("."+n)[0]||a.selectFirst&&h[0])},show:function(){var d=c(b).offset();j.css({width:"string"==typeof a.width||0<a.width?a.width:c(b).width(),top:d.top+b.offsetHeight,left:d.left}).show();
if(a.scroll){var d={"overflow-y":"auto"},f="auto",e=h[0].clientHeight;c.browser.msie&&(e=h[0].offsetHeight);if(0<a.scrollLimit)h.size()>a.scrollLimit&&(f=a.scrollLimit*e);else{var i;a:{i=a.scrollHeight;if(0<i)for(var k=0,l=0;l<h.length;l++)if(k+=h[l].clientHeight,k>=i){i=l+1;break a}i=0}0<i&&(f=i*e)}c.browser.msie?d.height=f:d.maxHeight=f;j.css(d);j[0].scrollTop=0}},selected:function(){return h&&c.data(h.filter("."+n)[0],"ac_data")},unbind:function(){j&&j.remove()}}};c.Autocompleter.Selection=function(a,
b,c){if(a.createTextRange){var p=a.createTextRange();p.collapse(!0);p.moveStart("character",b);p.moveEnd("character",c);p.select()}else a.setSelectionRange?a.setSelectionRange(b,c):a.selectionStart&&(a.selectionStart=b,a.selectionEnd=c);a.focus()}})(jQuery);
